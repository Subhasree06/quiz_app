<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Take Quiz</title>
  <style>
    :root {
      --bg: linear-gradient(145deg, #654ea3, #eaafc8);
      --card: #ffffff22;
      --accent: #8e2de2;
      --muted: #d1c4e9;
      --danger: #ef4444;
      --success: #22c55e;
      --text: #fff;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Roboto, Inter, Arial, sans-serif;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      flex: 1;
      padding: 30px;
      width: 100%;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .card {
      background: var(--card); 
      backdrop-filter: blur(12px);
      padding: 20px; 
      border-radius: 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.4);
      color: #fff;
    }
    .card h2 { margin-bottom: 12px; }
    .options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    .option-btn {
      padding: 10px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
    }
    .option-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.4);
      background: linear-gradient(135deg,#8e2de2,#c084fc);
    }
    button.main-btn {
      padding: 12px 18px;
      border-radius: 14px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      background: linear-gradient(135deg,#8e2de2,#c084fc);
      color: #fff;
      margin-top: 10px;
    }
    button.main-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
      background: linear-gradient(135deg,#c084fc,#8e2de2);
    }
    #scoreCard { display: none; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="quizCard">
      <h2 id="quizTitle">Loading Quiz...</h2>
      <p id="questionText"></p>
      <div class="options" id="optionsContainer"></div>
    </div>
    <div class="card" id="scoreCard">
      <h2>Quiz Completed üéâ</h2>
      <p>Your Score: <span id="score"></span></p>
      <button class="main-btn" onclick="window.location.href='home.html'">üè† Back to Dashboard</button>
      <button class="main-btn" onclick="window.location.href='leaderboard.html'">üèÜ View Leaderboard</button>
    </div>
  </div>

  <script>
    // Check login
    const loggedInEmail = localStorage.getItem('quiz_logged_in');
    if(!loggedInEmail){
      alert('Please login first!');
      window.location.href = 'index.html';
    }

    // Load quiz
    const urlParams = new URLSearchParams(window.location.search);
    const quizId = urlParams.get('id');
    const quizzes = JSON.parse(localStorage.getItem('created_quizzes') || '[]');
    const quiz = quizzes.find(q => q.id == quizId);

    const quizTitleEl = document.getElementById('quizTitle');
    const questionText = document.getElementById('questionText');
    const optionsContainer = document.getElementById('optionsContainer');
    const scoreCard = document.getElementById('scoreCard');
    const scoreDisplay = document.getElementById('score');
    const quizCard = document.getElementById('quizCard');

    let currentQ = 0;
    let score = 0;
    let questions = [];

    function shuffleArray(arr){
      for(let i = arr.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    if(!quiz){
      quizTitleEl.textContent = 'Quiz not found!';
      questionText.style.display = 'none';
    } else {
      quizTitleEl.textContent = quiz.title;

      // Shuffle questions
      questions = shuffleArray([...quiz.questions]);

      // Shuffle options for each question
      questions.forEach(q=>{
        const originalAns = q.options[q.answer];
        q.options = shuffleArray([...q.options]);
        q.answer = q.options.findIndex(opt=>opt === originalAns);
      });

      function loadQuestion(index){
        const q = questions[index];
        questionText.textContent = `Q${index+1}: ${q.question}`;
        optionsContainer.innerHTML = '';
        q.options.forEach((opt,i)=>{
          const btn = document.createElement('button');
          btn.textContent = opt;
          btn.classList.add('option-btn');
          btn.addEventListener('click', ()=>{
            if(i === q.answer) score++;
            if(currentQ < questions.length-1){
              currentQ++;
              loadQuestion(currentQ);
            } else {
              finishQuiz();
            }
          });
          optionsContainer.appendChild(btn);
        });
      }

      function finishQuiz(){
        quizCard.style.display = 'none';
        scoreCard.style.display = 'block';
        scoreDisplay.textContent = `${score} / ${questions.length}`;

        // ‚úÖ Save result to leaderboard (localStorage)
        const results = JSON.parse(localStorage.getItem('quiz_results') || '[]');
        results.push({
          email: loggedInEmail,
          name: loggedInEmail.split('@')[0], 
          score: score,
          total: questions.length,
          quizId: quiz.id,
          quizTitle: quiz.title,
          date: new Date().toLocaleString()
        });
        localStorage.setItem('quiz_results', JSON.stringify(results));
      }

      loadQuestion(currentQ);
    }
  </script>
</body>
</html>
